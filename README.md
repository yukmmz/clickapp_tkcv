
## 使い方（Mac では動作未確認）

### 仮想環境構築
おそらく python3.12 であればどのバージョンでも動作すると思います。動作確認は Python 3.12.10 で行っています。
インストールされていない場合は、以下の手順でインストールしてください。
1. Python 3.12.10 をインストール(https://www.python.org/downloads/release/python-31210/)。その際、"Add Python to PATH" にチェックを入れること。
1. コマンドプロンプト (Windows) または ターミナル (Mac) で、`python3.12 --version` を実行してもしバージョンが表示されない場合、python3.12の実行ファイル python.exe をコピペして、python3.12.exe にリネームする。  
   Windows の場合、C:\Users\<ユーザー名>\AppData\Local\Programs\Python\Python312 にあるはず。  
   Mac の場合、/usr/local/bin/python3.12 にあるはず。
1. bat ファイル (Windows) または command ファイル (Mac) をダブルクリックして実行し、仮想環境を構築する。  
   - Windows  
       build.bat をダブルクリックして実行する。
   - Mac  
       1. ターミナルで`chmod +x build.command`を実行して実行権限を与える。
       2. build.command をダブルクリックして実行する。


### GUIの起動
- Windows  
    run.bat をダブルクリックして実行する。
- Mac    
    1. 一度だけ、ターミナルで`chmod +x run.command`を実行して実行権限を与える。
    2. run.command をダブルクリックして実行する。


### GUIの使い方
**注意点**  
- マルチディスプレイ環境では、ウィンドウが起動時に表示されたディスプレイのみでクリック作業をすること。
- キャリブレーション後は、できるだけウィンドウサイズを変えないようにしてほしいです。（ウィンドウズの変更方法によっては異常が出る可能性があるため）


**3つのモード**  
GUIの右上のボタンの内、ハイライトされているボタンが現在のモードを示す。
- Calibration mode  
    画像上の2点をクリックして、対応する実世界座標を入力することで、画像座標と実世界座標の対応関係を設定するモード。C ボタンを押して入る。キャリブレーションが完了すると自動的に Add modeに入る。
- Add mode  
    各フレームで任意の点をクリックして、クリックされた点の画面上の座標と実世界座標を保存するモード。
- Delete mode  
    各フレームで任意の点をクリックして、クリックされた点に最も近い点を削除するモード。


**作業フロー**
1. （推奨：）全画面表示にする。
1. Ctrl+o で該当の動画ファイルを選択
1. （自動的に Calibration mode に入る。）
1. キャリブレーション点をクリックして、ポップアップに実世界座標を入力。これを2点繰り返す。x,y 座標が異なる2点を選ぶこと。
1. （自動的に Add mode に入る。）
1. 各フレームで任意の点をクリックして追加。消したい点があれば Delete mode に入り、該当の点をクリックして削除。


**ショートカットキー**
- Ctrl+o : 動画ファイルを開く
- Ctrl+s : データを保存
- → or X : 次のフレームへ
- ← or Z : 前のフレームへ
- a : Add mode に入る
- d : Delete mode に入る
- c : Calibration mode に入る
- e: settings ダイアログを表示（マーカーサイズやマーカー色の変更）
- h : ヘルプダイアログを表示
  










## Working memo

### commands 1
click_gui.py に、
tkinter + openCV を使った汎用的なクリックアプリを作ってほしい。

GUIを起動したら、
・動画ファイルを選択する。（エクスプローラーでもドラッグアンドドロップでも良い）
・まず動画の先頭のフレームを表示する。
・Calib ボタンを押すと、キャリブレーションモードに入り、
    ・キャリブレーション点をクリック（クリックされた点を赤色で表示）→対応する実世界の座標を入力、を2回繰り返す。
    ・キャリブレーションが完了したら、通常モードに戻る
・Add ボタンを押すと、クリック点追加モードに入る。各フレームで任意の点をクリックできるようになる。
    ・coords_raw[i][j] = [x_raw, y_raw] に i 番目のフレームでj番目にクリックされた画像上の座標 x_raw, y_raw を保存する。
    ・coords_real[i][j] = [x_real, y_real] に i 番目のフレームでj番目にクリックされた実世界座標 x_real, y_real を保存する。
    ・クリックされた点を緑色で表示する（つまり、coords_raw[i]の全ての点をプロットしなおす）
    ・クリックするたびに、その点の実世界座標を計算して表示する。
・Del ボタンを押すと、クリック点削除モードに入る。各フレームで任意の点をクリックして削除できるようになる。
    ・クリックされた点に最も近い点を coords_raw[i] と coords_real[i] から削除する。
    ・削除された点をプロットから消す。（つまり、coords_raw[i]の全ての点をプロットしなおす）
    ・削除するたびに、その点の実世界座標を表示する。
・次のフレーム、前のフレームに移動するボタンを押すと、対応するフレームに移動する。→coords_raw[i_specified]の全ての点をプロットしなおす
・保存ボタンを押すと、エクスプローラーが開く。
    ・保存先のファイル名を指定。
    ・coords_raw と coords_real を一つの .mat ファイルに保存する。

・以上の各操作のログを、GUIの上部のテキストエリアに表示する。

さらに、
・キーボードショートカットの実装（保存はctrl+s, 次フレームは右矢印キー、前フレームは左矢印キー、Addモードはaキー、Delモードはdキー、Calibモードはcキー）
・ヘルプダイアログの実装
の実装も行ってほしい。

さらに、
・click_gui.py を実行しても動作するし、外部から import しても動作するようにしてほしい。


### commands 2
<!-- キャリブレーション時に、クリックしてすぐに赤丸を表示してほしい。（ポップアップ出す前に） -->
<!-- キャリブレーションモードが完了したら自動的にAddモードに入ってほしい。 -->
<!-- 今どのモードかが分かるように、可能であれば、現在のモードのボタンをハイライト表示してほしい。無理ならば、ウィンドウの右上に大きな文字でモードを書いてほしい。 -->


<!-- ノーマルモードを'none'モードに変更してほしい。 -->

<!-- 起動時はキャリブレーションモードに入ってほしい。 -->
<!-- noneモードの時にクリックしたら、警告ダイアログを出してほしい。 -->
<!-- キャリブレーションしないままAddモードに入ろうとしたら、警告ダイアログを出してほしい。 -->

<!-- setting ボタンを追加して、このボタンを押したら、マーカーサイズやマーカー色を変更できるダイアログを出して、クラス属性を変更するなどして、プロットを再描画してほしい。 -->


### commands final
<!-- 色の指定や、モードの名前など、ハードコーディングとなっているものを、ファイルの先頭でまとめて大文字変数として定義してほしい。 -->

<!-- Add ボタンのラベルに"Add(a)"のように、キーボードショートカットも表示してほしい。 -->
<!-- 
レイアウトを以下のようにしてほしい。
    - フレームを移動するボタンはプロットの下に配置する。
    - プロットの真下に、現在のフレーム番号と、総フレーム数を表示するラベルを配置する。
    - 今ウィンドウの左上にあるが、これを、右側にずらして、モードを表すボタンたちは'mode: 'という文字の右側に並べて、
    - 他のsettings等のボタンたちは、左寄せに配置する。 -->

<!-- 現状、起動してすぐにcalib モードに入っているが、openした後に、calib モードに入るようにしてほしい。（このときも、ハイライト表示が更新されるように） -->

<!-- claibモード完了後に自動的にaddモードに入った際に、ボタンのハイライト表示が更新されていない。
モードが変更したときは必ずupdate_mode_buttons()を呼ぶようにしてほしい。 -->


<!-- キャリブレーション点が更新されたときは、coords_raw から coords_real を再計算するようにして。 -->


### memo
